{% extends "base.html" %}
{% block content %}

<div class="recent-card">
  <div class="d-flex justify-content-between align-items-center">
    <h4 class="mb-0">Knowledge Base</h4>
  </div>

  <p class="small-muted mb-3">Find answers to common IT issues and troubleshooting guides.</p>

  <!-- Search Bar -->
  <input id="kb-search" class="form-control mb-3" placeholder="Search keywordsâ€¦">

  <!-- Categories -->
  <h6 class="mt-3">Categories</h6>
  <div class="d-flex flex-wrap gap-2 mt-2">
    {% for cat in categories %}
      <span class="badge bg-primary-subtle text-primary p-2" style="cursor:pointer"
        onclick="filterCategory('{{ cat }}')">
        <i class="bi bi-folder2"></i> {{ cat }}
      </span>
    {% endfor %}
    <span class="badge bg-secondary-subtle text-dark p-2" onclick="filterCategory('all')" style="cursor:pointer">
      Show All
    </span>
  </div>

  <!-- Articles List -->
  <div class="accordion mt-4" id="kbAccordion">
    {% for article in articles %}
    <div class="accordion-item kb-article" data-category="{{ article.category }}">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed kb-title" type="button" data-bs-toggle="collapse"
                data-bs-target="#article{{ article.id }}">
          {{ article.title }}
        </button>
      </h2>
      <div id="article{{ article.id }}" class="accordion-collapse collapse">
        <div class="accordion-body">
          <p class="small-muted">{{ article.short }}</p>
          <button class="btn btn-sm btn-primary" onclick="openArticle('{{ article.id }}')">
            Open Full Article
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- ARTICLE MODAL -->
<div class="modal fade" id="articleModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modalTitle" class="modal-title"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalContent"></div>
    </div>
  </div>
</div>

<script>
// SEARCH FILTER
document.getElementById("kb-search").addEventListener("input", function() {
  let s = this.value.toLowerCase();
  document.querySelectorAll(".kb-article").forEach(a => {
    let text = a.innerText.toLowerCase();
    a.style.display = text.includes(s) ? "" : "none";
  });
});

// CATEGORY FILTER
function filterCategory(cat) {
  document.querySelectorAll(".kb-article").forEach(a => {
    a.style.display = (cat === "all" || a.dataset.category === cat) ? "" : "none";
  });
}

// LOAD FULL ARTICLE (AJAX)
function openArticle(id) {
  fetch("/article/" + id)
    .then(r => r.json())
    .then(data => {
      document.getElementById("modalTitle").innerText = data.title;
      document.getElementById("modalContent").innerHTML = data.content;
      let modal = new bootstrap.Modal(document.getElementById("articleModal"));
      modal.show();
    });
}
</script>

{% endblock %}
